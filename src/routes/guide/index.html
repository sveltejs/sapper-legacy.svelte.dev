<svelte:head>
	<title>Learn Sapper</title>
</svelte:head>

<div ref:container class='content linkify listify'>
	{#each sections as section}
	<section id='{section.slug}'>
		<h2>
			{section.metadata.title}
			<small>
				<a href='https://github.com/sveltejs/sapper.svelte.technology/edit/master/content/guide/{section.file}' title='edit this section'>
					<Icon name='edit' /></a>
			</small>
		</h2>
		{@html section.html}
	</section>
	{/each}
</div>

<aside class='sidebar'>
	<GuideContents ref:contents />
</aside>

<style>
	.sidebar {
		display: none;
		position: fixed;
		left: 0;
		top: var(--nav-h);
		width: var(--sidebar-w);
		height: calc(100vh - var(--nav-h));
		padding: var(--top-offset) 0;
		font-family: var(--font-ui);
		overflow-y: auto;
	}

	.content {
		width: 100%;
		padding: var(--top-offset) var(--side-page);
		tab-size: 2;
	}

	@media (min-width: 768px) {
		.sidebar {
			display: block;
			left: var(--side-page);
		}

		.content {
			padding-left: calc(var(--side-page) + var(--sidebar-w) + 4rem);
		}
	}

	.content h2 {
		margin-top: 16rem;
		padding: 4rem 1.6rem 5.6rem;
		border-top: var(--border-w) solid var(--second);
		color: var(--second);
	}

	.content section:first-of-type > h2 {
		margin-top: 0;
	}

	.content :global(h3),
	.content :global(h3 > code) {
		pointer-events: none;
		font: 300 var(--h3) var(--font-ui);
		color: black;
		padding: 6.4rem 0 1.6rem 0;
	}

	/* max line-length ~60 chars */
	section > :global(p) {
		max-width: var(--linemax)
	}

	small {
		font-size: var(--h5);
		float: right;
		pointer-events: all;
		color: var(--prime);
		cursor: pointer;
	}

	/* no linkify on these */
	small a        { all: unset }
	small a:before { all: unset }


	section :global(blockquote) {
		color: var(--flash);
		border: var(--border-w) solid currentColor;
		padding-left: 8.8rem;
	}

	section :global(blockquote::before) {
		content: ' ';
		position: absolute;
		top: 1.8rem;
		left: 3.2rem;
		width: 3rem;
		height: 3rem;
		background-repeat: no-repeat;
		background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='#40b3ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z'/%3E%3Cline x1='12' y1='9' x2='12' y2='13'/%3E%3Cline x1='12' y1='17' x2='12' y2='17'/%3E%3C/svg%3E");
	}
</style>

<script>
	export default {
		components: {
			GuideContents: '../../components/guide-contents.html',
			Icon: '../../components/icon.html',
		},

		preload() {
			return this.fetch(`guide.json`).then(r => r.json()).then(sections => {
				return { sections };
			});
		},

		oncreate() {
			const anchors = this.refs.container.querySelectorAll('[id]');
			let positions;
			
			const onresize = () => {
				const { top } = this.refs.container.getBoundingClientRect();
				positions = [].map.call(anchors, anchor => {
					return anchor.getBoundingClientRect().top - top;
				});
			}

			let lastId = window.location.hash.slice(1);

			const onscroll = () => {
				const top = -window.scrollY;

				let i = anchors.length;
				while (i--) {
					if (positions[i] + top < 40) {
						const anchor = anchors[i];
						const { id } = anchor;

						if (id !== lastId) {
							this.store.set({ activeGuideSection: id });
							this.fire('scroll', id);

							lastId = id;
						}
						return;
					}
				}
			};

			window.addEventListener('scroll', onscroll, true);
			window.addEventListener('resize', onresize, true);

			// wait for fonts to load...
			const timeouts = [
				setTimeout(onresize, 1000),
				setTimeout(onresize, 5000)
			];

			this.on('destroy', () => {
				window.removeEventListener('scroll', onscroll, true);
				window.removeEventListener('resize', onresize, true);

				timeouts.forEach(timeout => clearTimeout(timeout));
			});

			onresize();
			onscroll();
		}
	};
</script>